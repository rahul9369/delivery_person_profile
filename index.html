<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profile Form</title>
    <style>
      /* Resetting some default styles */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #f5f7fa;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      .container {
        width: 90vw;
        height: 85vh;
        display: flex;
        justify-content: space-between;
      }

      .image-section {
        width: 30%;
        text-align: center;
        margin: 5px;
        border-radius: 10px;
        height: 70vh;
      }

      .image-section img {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        margin: 20px;
      }

      .image-container {
        border: 1px solid rgb(203, 203, 203);
        border-radius: 5px;
        height: auto;
        background-color: white;
      }

      .image-section input {
        display: none;
        padding-bottom: 10px;
      }

      .image-section label {
        background-color: #007bff;
        color: #fff;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-bottom: 20px;
      }

      .change-password-section {
        margin-top: 20px;
      }

      .change-password-section button {
        background-color: white;
        color: black;
        width: 100%;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin-bottom: 20px;
        border: 1px solid rgb(203, 203, 203);
      }

      .change-password-section button:hover {
        background-color: #dfdede;
      }

      .form-section {
        width: 70%;
        border: 1px solid #ddd;
        border-radius: 10px;
        background-color: #fff;
        height: fit-content;
        margin: 5px;
      }

      h4 {
        text-align: center;
        padding: 1px;
        border-radius: 5px;
        color: black;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        width: 50%;
        padding: 0px 20px;
        margin-bottom: 20px;
      }

      .form-group label {
        color: #333;
        font-size: 14px;
        padding: 5px 0;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ced4da;
        font-size: 14px;
        margin-top: 2px;
      }

      .form-row {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
      }

      button {
        background-color: #007bff;
        color: #fff;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        display: inline-block;
        margin-right: 10px;
      }

      button:hover {
        background-color: #0056b3;
      }

      .button-group {
        display: flex;

        justify-content: flex-start;
        margin-bottom: 20px;
        margin-left: 20px;
      }

      @media (max-width: 768px) {
        .container {
          flex-direction: column;
          padding: 10px;
          height: auto;
        }

        .image-section {
          width: 100%;
          border-right: none;
          border-bottom: 1px solid #ddd;
          padding-bottom: 10px;
          margin-bottom: 10px;
        }

        .image-section img {
          width: 100px;
          height: 100px;
        }

        .form-section {
          width: 100%;
        }

        .form-row {
          flex-direction: column;
        }

        .form-group {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Image and Change Password Section -->

      <div class="image-section">
        <div class="image-container">
          <div
            style="
              background-color: rgba(33, 40, 50, 0.03);
              padding: 10px;
              margin-bottom: 10px;
            ">
            <h4>Profile Picture</h4>
          </div>
          <img
            src="https://via.placeholder.com/150"
            alt="Profile Picture"
            id="profileImage" />
          <br />
          <input type="file" id="imageUpload" accept="image/*" />
          <label for="imageUpload">Upload new image</label>
          <br />
          <br />
          <br />
        </div>
        <div class="change-password-section">
          <button id="changePasswordButton" type="button">
            Change Password
          </button>
        </div>
      </div>

      <!-- Main Form Section -->
      <div class="form-section" id="formSection">
        <h4
          style="
            background-color: rgba(33, 40, 50, 0.03);
            padding: 10px;
            margin-bottom: 10px;
          ">
          Account Details
        </h4>
        <form id="userProfileForm">
          <div class="form-row">
            <div class="form-group">
              <label for="username">Username</label>
              <input
                type="text"
                id="username"
                name="username"
                placeholder="Username"
                disabled />
            </div>
            <div class="form-group">
              <label for="email">Email</label>
              <input
                type="email"
                id="email"
                name="email"
                placeholder="Email"
                disabled />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="user_type">User Type</label>
              <select id="user_type" name="user_type" disabled>
                <option value="" disabled selected>User Type</option>
                <option value="delivery_person">Delivery Person</option>
                <option value="customer">Customer</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div class="form-group">
              <label for="name">Full Name</label>
              <input
                type="text"
                id="name"
                name="name"
                placeholder="Full Name"
                disabled />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="phone_number">Phone Number</label>
              <input
                type="tel"
                id="phone_number"
                name="phone_number"
                placeholder="Phone Number"
                disabled />
            </div>
            <div class="form-group">
              <label for="address">Address</label>
              <input
                type="text"
                id="address"
                name="address"
                placeholder="Address"
                disabled />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="aadhaar_card_number">Aadhaar Card Number</label>
              <input
                type="text"
                id="aadhaar_card_number"
                name="aadhaar_card_number"
                placeholder="Aadhaar Card Number"
                disabled />
            </div>
            <div class="form-group">
              <label for="vehicle_details">Vehicle Details</label>
              <input
                type="text"
                id="vehicle_details"
                name="vehicle_details"
                placeholder="Vehicle Details"
                disabled />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="availability_status">Availability Status</label>
              <select
                id="availability_status"
                name="availability_status"
                disabled>
                <option value="" disabled selected>Availability Status</option>
                <option value="Available">Available</option>
                <option value="Unavailable">Unavailable</option>
              </select>
            </div>
            <div class="form-group">
              <label for="rating">Rating</label>
              <input
                type="number"
                id="rating"
                name="rating"
                step="0.1"
                placeholder="Rating"
                disabled />
            </div>
          </div>
          <div class="button-group">
            <button id="saveButton" type="button">Change Information</button>
          </div>
        </form>
      </div>

      <!-- Change Password Form (Initially Hidden) -->
      <div
        class="form-section"
        id="changePasswordSection"
        style="display: none">
        <div
          style="
            background-color: rgba(33, 40, 50, 0.03);
            padding: 10px;
            margin-bottom: 10px;
          ">
          <h4>Change Password</h4>
        </div>
        <form id="changePasswordForm">
          <div class="form-row">
            <div class="form-group">
              <label for="old_password">Old Password</label>
              <input
                type="password"
                id="old_password"
                name="old_password"
                placeholder="Old Password"
                required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="new_password">New Password</label>
              <input
                type="password"
                id="new_password"
                name="new_password"
                placeholder="New Password"
                required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="confirm_new_password">Confirm New Password</label>
              <input
                type="password"
                id="confirm_new_password"
                name="confirm_new_password"
                placeholder="Confirm New Password"
                required />
            </div>
          </div>
          <div class="button-group">
            <button type="submit">Submit</button>
            <button type="button" id="cancelChangePassword">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Function to get token from local storage
      function getToken() {
        const token = localStorage.getItem("accessToken");
        if (!token) {
          alert("Token not found. Please log in again.");
          return null;
        }
        return token;
      }

      // Fetching data on page load
      document.addEventListener("DOMContentLoaded", function () {
        const token = getToken();
        if (token) {
          fetch("http://13.201.28.236:8000/profile-delivery-person/", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("Failed to fetch user profile");
              }
              return response.json();
            })
            .then((data) => {
              console.log(data);

              // Populate the form with the fetched data
              document.getElementById("username").value = data.username || "";
              document.getElementById("email").value = data.email || "";
              document.getElementById("user_type").value = data.user_type || "";
              document.getElementById("name").value = data.name || "";
              document.getElementById("phone_number").value =
                data.phone_number || "";
              document.getElementById("address").value = data.address || "";
              document.getElementById("aadhaar_card_number").value =
                data.aadhaar_card_number || "";
              document.getElementById("vehicle_details").value =
                data.vehicle_details || "";
              document.getElementById("availability_status").value =
                data.availability_status || "";
              document.getElementById("rating").value = data.rating || "";
            })
            .catch((error) => {
              console.error("Error fetching user profile:", error);
            });
        }
      });

      // Toggle edit mode and save functionality
      document
        .getElementById("saveButton")
        .addEventListener("click", function () {
          const formElements =
            document.getElementById("userProfileForm").elements;

          if (this.innerText === "Change Information") {
            for (let element of formElements) {
              element.disabled = false;
            }
            this.innerText = "Save";
          } else {
            const token = getToken();
            if (token) {
              const formData = new FormData(
                document.getElementById("userProfileForm")
              );
              const jsonData = {};
              formData.forEach((value, key) => {
                jsonData[key] = value;
              });

              fetch(
                "http://13.201.28.236:8000/update-profile-delivery-person/",
                {
                  method: "PUT",
                  headers: {
                    Authorization: `Bearer ${token}`,
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(jsonData),
                }
              )
                .then((response) => {
                  if (!response.ok) {
                    throw new Error("Failed to save user profile");
                  }
                  return response.json();
                })
                .then((data) => {
                  console.log("Profile saved:", data);

                  // Disable the form fields after saving
                  for (let element of formElements) {
                    element.disabled = true;
                  }
                  this.innerText = "Change Information";
                  alert("Profile updated successfully!");
                })
                .catch((error) => {
                  console.error("Error saving user profile:", error);
                  alert("Failed to update profile. Please try again.");
                });
            }
          }
        });

      // Image upload functionality
      document
        .getElementById("imageUpload")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              document.getElementById("profileImage").src = e.target.result;
              // Optionally, you can upload the image to the server here
            };
            reader.readAsDataURL(file);
          }
        });

      // Toggle between profile form and change password form
      document
        .getElementById("changePasswordButton")
        .addEventListener("click", function () {
          document.getElementById("formSection").style.display = "none";
          document.getElementById("changePasswordSection").style.display =
            "block";
        });

      // Cancel Change Password
      document
        .getElementById("cancelChangePassword")
        .addEventListener("click", function () {
          document.getElementById("changePasswordForm").reset();
          document.getElementById("changePasswordSection").style.display =
            "none";
          document.getElementById("formSection").style.display = "block";
        });

      // Change Password Form submission
      document
        .getElementById("changePasswordForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const token = getToken(); // Use your existing getToken function

          if (token) {
            const oldPassword = document.getElementById("old_password").value;
            const newPassword = document.getElementById("new_password").value;
            const confirmNewPassword = document.getElementById(
              "confirm_new_password"
            ).value;

            if (newPassword !== confirmNewPassword) {
              alert("New password and confirmation do not match.");
              return;
            }

            const requestData = {
              old_password: oldPassword,
              new_password: newPassword,
            };

            fetch("http://13.201.28.236:8000/change-password/", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(requestData),
            })
              .then((response) => {
                if (!response.ok) {
                  throw new Error("Failed to change password");
                }
                return response.json();
              })
              .then((data) => {
                console.log("Password changed:", data);
                alert("Password changed successfully!");
                // Optionally redirect back to profile form
                document.getElementById("changePasswordForm").reset();
                document.getElementById("changePasswordSection").style.display =
                  "none";
                document.getElementById("formSection").style.display = "block";
              })
              .catch((error) => {
                console.error("Error changing password:", error);
                alert("Failed to change password. Please try again.");
              });
          }
        });
    </script>
  </body>
</html>
