<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profile Form</title>
    <style>
      /* Resetting some default styles */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #f5f7fa;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      .container {
        width: 90vw;
        height: 85vh;
        display: flex;
        justify-content: space-between;
      }

      .image-section {
        width: 30%;
        text-align: center;
        border: 1px solid #ddd;
        padding-bottom: 20px;
        margin: 5px;
        border-radius: 10px;
        height: 350px;
      }

      .image-section img {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        margin-bottom: 20px;
      }

      .image-section input {
        display: none;
        padding-bottom: 10px;
      }

      .image-section label {
        background-color: #007bff;
        color: #fff;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      .form-section {
        margin-top: 10px;
        width: 70%;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin: 5px;
      }

      h2 {
        text-align: center;
        margin-top: 15px;
        background-color: #16a290;
        padding: 10px;
        border-radius: 5px;
        color: white;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        width: 48%;
        padding: 0px 10px;
      }

      .form-group label {
        color: #333;
        font-weight: 12px;
        padding: 1px;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ced4da;
        font-size: 14px;
        margin-top: 2px;
      }

      .form-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      button {
        background-color: #007bff;
        color: #fff;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        display: inline-block;
        margin-right: 10px;
      }

      button:hover {
        background-color: #0056b3;
      }

      .button-group {
        font-size: bold;
        margin-left: 20px;
      }

      @media (max-width: 768px) {
        .container {
          flex-direction: column;
          padding: 10px;
          height: auto;
        }

        .image-section {
          width: 100%;
          border-right: none;
          border-bottom: 1px solid #ddd;
          padding-bottom: 10px;
          margin-bottom: 10px;
        }

        .image-section img {
          width: 100px;
          height: 100px;
        }

        .form-section {
          width: 100%;
        }

        .form-row {
          flex-direction: column;
        }

        .form-group {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="image-section">
        <div
          style="
            background-color: rgba(33, 40, 50, 0.03);
            padding: 10px;
            margin-bottom: 10px;
          ">
          <h4>Profile Picture</h4>
        </div>
        <img
          src="https://via.placeholder.com/150"
          alt="Profile Picture"
          id="profileImage" />
        <br />
        <input type="file" id="imageUpload" accept="image/*" />
        <label for="imageUpload">Upload new image</label>
      </div>
      <div class="form-section">
        <h4
          style="
            background-color: rgba(33, 40, 50, 0.03);
            padding: 10px;
            margin-bottom: 10px;
          ">
          Account Details
        </h4>
        <form id="userProfileForm">
          <div class="form-row">
            <div class="form-group">
              <label for="username">Username</label>
              <input
                type="text"
                id="username"
                name="username"
                placeholder="Username"
                disabled />
            </div>
            <div class="form-group">
              <label for="email">Email</label>
              <input
                type="email"
                id="email"
                name="email"
                placeholder="Email"
                disabled />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="user_type">User Type</label>
              <select id="user_type" name="user_type" disabled>
                <option value="" disabled selected>User Type</option>
                <option value="delivery_person">Delivery Person</option>
                <option value="customer">Customer</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div class="form-group">
              <label for="name">Full Name</label>
              <input
                type="text"
                id="name"
                name="name"
                placeholder="Full Name"
                disabled />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="phone_number">Phone Number</label>
              <input
                type="tel"
                id="phone_number"
                name="phone_number"
                placeholder="Phone Number"
                disabled />
            </div>
            <div class="form-group">
              <label for="address">Address</label>
              <input
                type="text"
                id="address"
                name="address"
                placeholder="Address"
                disabled />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="aadhaar_card_number">Aadhaar Card Number</label>
              <input
                type="text"
                id="aadhaar_card_number"
                name="aadhaar_card_number"
                placeholder="Aadhaar Card Number"
                disabled />
            </div>
            <div class="form-group">
              <label for="vehicle_details">Vehicle Details</label>
              <input
                type="text"
                id="vehicle_details"
                name="vehicle_details"
                placeholder="Vehicle Details"
                disabled />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="availability_status">Availability Status</label>
              <select
                id="availability_status"
                name="availability_status"
                disabled>
                <option value="" disabled selected>Availability Status</option>
                <option value="Available">Available</option>
                <option value="Unavailable">Unavailable</option>
              </select>
            </div>
            <div class="form-group">
              <label for="rating">Rating</label>
              <input
                type="number"
                id="rating"
                name="rating"
                step="0.1"
                placeholder="Rating"
                disabled />
            </div>
          </div>
          <div class="button-group">
            <button id="saveButton" type="button">Change Information</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Function to get token from local storage
      function getToken() {
        const token = localStorage.getItem("accessToken");
        if (!token) {
          alert("Token not found. Please log in again.");
          return null;
        }
        return token;
      }

      // Fetching data on page load
      document.addEventListener("DOMContentLoaded", function () {
        const token = getToken();
        if (token) {
          fetch("http://13.201.28.236:8000/profile-delivery-person/", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("Failed to fetch user profile");
              }
              return response.json();
            })
            .then((data) => {
              console.log(data);

              // Populate the form with the fetched data
              document.getElementById("username").value = data.username || "";
              document.getElementById("email").value = data.email || "";
              document.getElementById("user_type").value = data.user_type || "";
              document.getElementById("name").value = data.name || "";
              document.getElementById("phone_number").value =
                data.phone_number || "";
              document.getElementById("address").value = data.address || "";
              document.getElementById("aadhaar_card_number").value =
                data.aadhaar_card_number || "";
              document.getElementById("vehicle_details").value =
                data.vehicle_details || "";
              document.getElementById("availability_status").value =
                data.availability_status || "";
              document.getElementById("rating").value = data.rating || "";
            })
            .catch((error) => {
              console.error("Error fetching user profile:", error);
            });
        }
      });

      // Toggle edit mode and save functionality
      document
        .getElementById("saveButton")
        .addEventListener("click", function () {
          const formElements =
            document.getElementById("userProfileForm").elements;

          if (this.innerText === "Change Information") {
            for (let element of formElements) {
              element.disabled = false;
            }
            this.innerText = "Save";
          } else {
            const token = getToken();
            if (token) {
              const formData = new FormData(
                document.getElementById("userProfileForm")
              );
              const jsonData = {};
              formData.forEach((value, key) => {
                jsonData[key] = value;
              });

              fetch(
                "http://13.201.28.236:8000/update-profile-delivery-person/",
                {
                  method: "PUT",
                  headers: {
                    Authorization: `Bearer ${token}`,
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(jsonData),
                }
              )
                .then((response) => {
                  if (!response.ok) {
                    throw new Error("Failed to save user profile");
                  }
                  return response.json();
                })
                .then((data) => {
                  console.log("Profile saved:", data);

                  // Disable the form fields after saving
                  for (let element of formElements) {
                    element.disabled = true;
                  }
                  this.innerText = "Change Information";
                })
                .catch((error) => {
                  console.error("Error saving user profile:", error);
                });
            }
          }
        });

      // Image upload functionality
      document
        .getElementById("imageUpload")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              document.getElementById("profileImage").src = e.target.result;
            };
            reader.readAsDataURL(file);
          }
        });
    </script>
  </body>
</html>
